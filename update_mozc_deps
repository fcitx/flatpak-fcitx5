#!/bin/bash

BASE=$PWD
pushd .
if [ ! -d mozc ]; then
    git clone --filter=tree:0 https://github.com/fcitx/mozc/
fi

cd mozc/src/
git fetch --all
git checkout origin/fcitx
git submodule update --init

set -e

flatpak run --share=network --filesystem=host --filesystem=xdg-cache --filesystem=/tmp --runtime=org.kde.Sdk//6.6 --command=sh --env=PKG_CONFIG_PATH=/app/lib/pkgconfig org.fcitx.Fcitx5 -c "/usr/lib/sdk/bazel/bin/bazel clean --expunge"

_MOZC_BAZEL_CACHE=/tmp/mozc_cache

rm -rf $_MOZC_BAZEL_CACHE
target="unix/fcitx5:fcitx5-mozc.so server:mozc_server gui/tool:mozc_tool"
    flatpak run --env=CC=/usr/bin/clang --env=CXX=/usr/bin/clang++ --share=network --filesystem=host --filesystem=xdg-cache --filesystem=/tmp --runtime=org.kde.Sdk//6.6 --command=sh --env=PKG_CONFIG_PATH=/app/lib/pkgconfig org.fcitx.Fcitx5 -c "/usr/lib/sdk/bazel/bin/bazel build --nobuild --repository_cache="$_MOZC_BAZEL_CACHE" --config oss_linux --config release_build --noenable_bzlmod $target"

pushd .
cd $_MOZC_BAZEL_CACHE
for f in `find -name 'id*'` ; do
    echo "- type: file"
    echo -n "  url: "
    awk '{print $1}' $f
    echo "  dest: bazel-deps"
    sha=`dirname $f`
    sha=`basename $sha`
    echo "  sha256: $sha"
done > $BASE/mozc-deps.yaml
popd

yq -y -i 'sort_by(.url)' $BASE/mozc-deps.yaml

rm -rf $_MOZC_BAZEL_CACHE

popd
$BASE/update_mozc_zip_code_patch
